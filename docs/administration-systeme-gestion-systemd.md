# Gestion des services systemd

<div class="couleur-introduction">
À partir des versions Jenkins 2.332.1 et Jenkins 2.335, les programmes d'installation des paquets Linux utilisent `systemd` pour gérer les services. Les programmes d'installation des paquets RPM et deb migrent les paramètres de configuration de System V `init` vers les remplacements `systemd`.
</div>
<p>
<iframe width="800" height="420" src="https://www.youtube.com/embed/pwR9TPW2oG4" title="🔴 Managing the Jenkins systemd Service on Ubuntu 20.04" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
</p>

## Affichage des configurations de service

La configuration actuelle du service Jenkins telle qu'elle a été définie par les programmes d'installation des paquets et les éventuels remplacements peut être consultée à l'aide de la commande suivante :

``` bash title="BASH"
systemctl cat jenkins
# /etc/systemd/system/jenkins.service
#
# This file is managed by systemd(1). Do NOT edit this file manually!
# To override these settings, run:
#
#     systemctl edit jenkins
#
# For more information about drop-in files, see:
#
#     https://www.freedesktop.org/software/systemd/man/systemd.unit.html
#

[Unit]
Description=Jenkins Continuous Integration Server
Requires=network.target
After=network.target

[Service]
Type=notify
NotifyAccess=main
ExecStart=/usr/bin/jenkins
Restart=on-failure
SuccessExitStatus=143

# /etc/systemd/system/jenkins.service.d/override.conf
[Service]
Environment="JAVA_OPTS=-Djava.awt.headless=true"
```

## Configurations de service prioritaires

Lorsqu'il est installé sur une distribution Linux moderne exécutant `systemd(1)`, le [service unit](https://www.freedesktop.org/software/systemd/man/systemd.service.html)  `systemd(1)` est fourni à :

**Debian**<br>
`/lib/systemd/system/jenkins.service`

**Red Hat**<br>
`/usr/lib/systemd/system/jenkins.service`

**openSUSE**<br>
`/usr/lib/systemd/system/jenkins.service`

L'unité de service principale est en lecture seule et n'est pas destinée à être modifiée manuellement. Elle contient une grande remarque en haut du fichier rappelant à l'utilisateur qu'elle est en lecture seule.

Les valeurs peuvent être remplacées dans l'unité drop-in (fichier `override.conf`) pour le service. Modifiez l'unité drop-in avec :

``` bash title="BASH"
# systemctl edit jenkins
```

Le fichier `override.conf` est stocké dans `/etc/systemd/system/jenkins.service.d/override.conf` et peut être utilisé pour personnaliser le service. Notez que ces personnalisations doivent être effectuées dans une section `[Service]` pour prendre effet. Voici un exemple de contenu du fichier `override.conf `:

``` cfg
[Unit]
Description=Contrôleur Jenkins de mon entreprise

[Service]
# Ajouter les options de configuration JVM
Environnement="JAVA_OPTS=-Djava.awt.headless=true -XX:+UseStringDeduplication"

# Arguments supplémentaires arbitraires à transmettre à Jenkins.
# Liste complète des options : java -jar jenkins.war --help
Environnement = « JENKINS_OPTS=--prefix=/jenkins --javaHome=/opt/jdk-21 »

# Répertoire de configuration en tant que code
Environment="CASC_JENKINS_CONFIG=/var/lib/jenkins/configuration-as-code/"
```

!!! warning "Avertissement"
    `systemctl edit jenkins` crée l'unité drop-in en tant que `root` avec les permissions 0644 (`-rw-r—​r--`). La logique de migration, quant à elle, crée l'unité drop-in en tant que root avec les permissions 0600 (-rw-------). Cela peut avoir des conséquences si vous stockez un emplacement de keystore HTTPS et/ou un mot de passe dans l'unité drop-in et que vous exécutez également des tâches directement sur le contrôleur, une pratique que le projet Jenkins [déconseille explicitement](./securite-isolation-du-controleur.md). En cas de doute, sécurisez l'unité drop-in en définissant ses autorisations sur 0600 avec `chmod(1)`.

L'unité drop-in unifie la configuration sur les trois distributions : Debian, Red Hat et openSUSE. Notez également que l'unité drop-in n'est pas écrasée lors des mises à niveau.

!! note "Inforation"
    Contrairement à la configuration System V `init(8)`, le fichier `override.conf `ne contient que des personnalisations, et non les valeurs par défaut d'origine. Les utilisateurs habitués à modifier un ensemble de valeurs par défaut existant doivent se référer à l'unité de service (en lecture seule) lors de la modification de l'unité drop-in ou utiliser une commande telle que `systemctl edit jenkins --full` qui copie l'unité de service d'origine au lieu de créer une unité drop-in.

La modification de l'unité drop-in avec `systemctl edit jenkins` recharge automatiquement la configuration `systemd(1)`. Les paramètres prendront effet au prochain redémarrage de Jenkins. Si vous modifiez l'unité drop-in sans `systemctl(1)`, vous devez exécuter `systemctl daemon-reload` pour que les modifications prennent effet.

Un dernier point à mentionner concernant l'unité de service est son utilisation de spécificateurs, qui peuvent être peu familiers à certains utilisateurs. L'unité drop-in n'effectue pas d'expansion de shell. Les spécificateurs peuvent insérer des informations contextuelles (telles que le nom d'hôte du système, le nom de l'unité et la version du noyau du système d'exploitation) dans l'unité drop-in. La documentation `systemd(1)` contient un [tableau des spécificateurs disponibles dans les fichiers d'unité](https://www.freedesktop.org/software/systemd/man/systemd.unit.html#id-1.13.3).

## Démarrage des services

Une fois le service Jenkins systemd défini, il peut être démarré avec :

``` bash title="BASH"
# systemctl start jenkins
```

Si Jenkins ne signale pas la fin du démarrage dans le délai configuré, le service sera considéré comme ayant échoué et sera à nouveau arrêté. À mesure que chaque étape d'initialisation (c'est-à-dire « Initialisation démarrée », « Tous les plugins répertoriés », « Tous les plugins préparés », « Tous les plugins démarrés », « Augmentation de toutes les extensions », « Chargement de la configuration système », « Adaptation de la configuration système », « Chargement de toutes les tâches », « Mise à jour de la configuration de toutes les tâches » et « Initialisation terminée ») est atteint, le délai d'expiration est prolongé de la valeur de la propriété système `jenkins.model.Jenkins.extendTimeoutSeconds` (par défaut, 15 secondes).  Le délai d'expiration peut être configuré à l'aide de la directive `TimeoutStartSec` dans l'unité de service.

## Arrêt des services

Le service Jenkins `systemd` peut être arrêté à l'aide de la commande suivante :

``` bash title="BASH"
# systemctl stop jenkins
```

## Redémarrage des services

Le service Jenkins `systemd` peut être redémarré à l'aide de la commande suivante :

``` bash title="BASH"
# systemctl restart jenkins
```

## Rechargement des définitions de service

Après avoir modifié les fichiers de configuration, il peut être nécessaire de recharger la définition du service à l'aide de la commande suivante :

``` bash title="BASH"
# systemctl daemon-reload
```

## Lecture des journaux de service

Les journaux du service Jenkins peuvent être lus à l'aide de la commande suivante :

``` bash title="BASH"
journalctl -u jenkins
```

## Nettoyage des journaux de service

Les fichiers journaux conservés par `systemd` sont généralement configurés pour être automatiquement rotés. Si vous souhaitez réduire la taille des fichiers journaux, utilisez la commande suivante :

``` bash title="BASH"
journalctl --vacuum-size=500M
```

## Affichage de l'état du service

L'état du service Jenkins `systemd` peut être affiché à l'aide de la commande `systemctl status jenkins`. Vous trouverez ci-dessous quelques exemples.

Après la mise à niveau des plugins :

``` bash title="BASH"
systemctl status jenkins
● jenkins.service - Serveur d'intégration continue Jenkins
     Chargé : chargé (/lib/systemd/system/jenkins.service ; activé ; préréglage du fournisseur : activé)
    Drop-In : /etc/systemd/system/jenkins.service.d
             └─override.conf
     Actif : actif (en cours d'exécution) […]
   PID principal : […] (java)
     Statut : « Redémarrage dans 10 secondes »
```

Lorsque Jenkins est arrêté :

``` bash title="BASH"
systemctl status jenkins
● jenkins.service - Serveur d'intégration continue Jenkins
     Chargé : chargé (/lib/systemd/system/jenkins.service ; activé ; préréglage du fournisseur : activé)
    Drop-In : /etc/systemd/system/jenkins.service.d
             └─override.conf
     Actif : désactivation (stop-sigterm) depuis […]
   PID principal : […] (java)
     Statut : « Arrêt de Jenkins »
```

Au démarrage de Jenkins :

``` bash title="BASH"
systemctl status jenkins
● jenkins.service - Serveur d'intégration continue Jenkins
     Chargé : chargé (/lib/systemd/system/jenkins.service ; activé ; préréglage du fournisseur : activé)
    Drop-In : /etc/systemd/system/jenkins.service.d
             └─override.conf
     Actif : activation (démarrage) depuis […]
   PID principal : […] (java)
```

Après un démarrage réussi :

``` bash title="BASH"
systemctl status jenkins
● jenkins.service - Serveur d'intégration continue Jenkins
     Chargé : chargé (/lib/systemd/system/jenkins.service ; activé ; préréglage du fournisseur : activé)
    Drop-In : /etc/systemd/system/jenkins.service.d
             └─override.conf
     Actif : actif (en cours d'exécution) depuis […]
   PID principal : […] (java
```

## Pour aller plus loin

Quelques lectures recommandées sur ce sujet :

* [Tutoriel sur les services et unités systemd de DigitalOcean](https://www.digitalocean.com/community/tutorials/how-to-use-systemctl-to-manage-systemd-services-and-units) ;
* [Comprendre et administrer systemd](https://docs.fedoraproject.org/en-US/quick-docs/understanding-and-administering-systemd/) par le projet Fedora ;
* [Documentation de référence sur systemd](https://www.freedesktop.org/wiki/Software/systemd/) par freedesktop.org ;
* [Wiki Debian : systemd](https://wiki.debian.org/systemd).

