# Gestion des services systemd

<div class="couleur-introduction">
Ã€ partir des versions Jenkins 2.332.1 et Jenkins 2.335, les programmes d'installation des paquets Linux utilisent `systemd` pour gÃ©rer les services. Les programmes d'installation des paquets RPM et deb migrent les paramÃ¨tres de configuration de System V `init` vers les remplacements `systemd`.
</div>
<p>
<iframe width="800" height="420" src="https://www.youtube.com/embed/pwR9TPW2oG4" title="ğŸ”´ Managing the Jenkins systemd Service on Ubuntu 20.04" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
</p>

## Affichage des configurations de service

La configuration actuelle du service Jenkins telle qu'elle a Ã©tÃ© dÃ©finie par les programmes d'installation des paquets et les Ã©ventuels remplacements peut Ãªtre consultÃ©e Ã  l'aide de la commande suivante :

``` bash title="BASH"
systemctl cat jenkins
# /etc/systemd/system/jenkins.service
#
# This file is managed by systemd(1). Do NOT edit this file manually!
# To override these settings, run:
#
#     systemctl edit jenkins
#
# For more information about drop-in files, see:
#
#     https://www.freedesktop.org/software/systemd/man/systemd.unit.html
#

[Unit]
Description=Jenkins Continuous Integration Server
Requires=network.target
After=network.target

[Service]
Type=notify
NotifyAccess=main
ExecStart=/usr/bin/jenkins
Restart=on-failure
SuccessExitStatus=143

# /etc/systemd/system/jenkins.service.d/override.conf
[Service]
Environment="JAVA_OPTS=-Djava.awt.headless=true"
```

## Configurations de service prioritaires

Lorsqu'il est installÃ© sur une distribution Linux moderne exÃ©cutant `systemd(1)`, le [service unit](https://www.freedesktop.org/software/systemd/man/systemd.service.html)  `systemd(1)` est fourni Ã  :

**Debian**<br>
`/lib/systemd/system/jenkins.service`

**Red Hat**<br>
`/usr/lib/systemd/system/jenkins.service`

**openSUSE**<br>
`/usr/lib/systemd/system/jenkins.service`

L'unitÃ© de service principale est en lecture seule et n'est pas destinÃ©e Ã  Ãªtre modifiÃ©e manuellement. Elle contient une grande remarque en haut du fichier rappelant Ã  l'utilisateur qu'elle est en lecture seule.

Les valeurs peuvent Ãªtre remplacÃ©es dans l'unitÃ© drop-in (fichier `override.conf`) pour le service. Modifiez l'unitÃ© drop-in avec :

``` bash title="BASH"
# systemctl edit jenkins
```

Le fichier `override.conf` est stockÃ© dans `/etc/systemd/system/jenkins.service.d/override.conf` et peut Ãªtre utilisÃ© pour personnaliser le service. Notez que ces personnalisations doivent Ãªtre effectuÃ©es dans une section `[Service]` pour prendre effet. Voici un exemple de contenu du fichier `override.conf `:

``` cfg
[Unit]
Description=ContrÃ´leur Jenkins de mon entreprise

[Service]
# Ajouter les options de configuration JVM
Environnement="JAVA_OPTS=-Djava.awt.headless=true -XX:+UseStringDeduplication"

# Arguments supplÃ©mentaires arbitraires Ã  transmettre Ã  Jenkins.
# Liste complÃ¨te des options : java -jar jenkins.war --help
Environnement = Â« JENKINS_OPTS=--prefix=/jenkins --javaHome=/opt/jdk-21 Â»

# RÃ©pertoire de configuration en tant que code
Environment="CASC_JENKINS_CONFIG=/var/lib/jenkins/configuration-as-code/"
```

!!! warning "Avertissement"
    `systemctl edit jenkins` crÃ©e l'unitÃ© drop-in en tant que `root` avec les permissions 0644 (`-rw-râ€”â€‹r--`). La logique de migration, quant Ã  elle, crÃ©e l'unitÃ© drop-in en tant que root avec les permissions 0600 (-rw-------). Cela peut avoir des consÃ©quences si vous stockez un emplacement de keystore HTTPS et/ou un mot de passe dans l'unitÃ© drop-in et que vous exÃ©cutez Ã©galement des tÃ¢ches directement sur le contrÃ´leur, une pratique que le projet Jenkins [dÃ©conseille explicitement](./securite-isolation-du-controleur.md). En cas de doute, sÃ©curisez l'unitÃ© drop-in en dÃ©finissant ses autorisations sur 0600 avec `chmod(1)`.

L'unitÃ© drop-in unifie la configuration sur les trois distributions : Debian, Red Hat et openSUSE. Notez Ã©galement que l'unitÃ© drop-in n'est pas Ã©crasÃ©e lors des mises Ã  niveau.

!! note "Inforation"
    Contrairement Ã  la configuration System V `init(8)`, le fichier `override.conf `ne contient que des personnalisations, et non les valeurs par dÃ©faut d'origine. Les utilisateurs habituÃ©s Ã  modifier un ensemble de valeurs par dÃ©faut existant doivent se rÃ©fÃ©rer Ã  l'unitÃ© de service (en lecture seule) lors de la modification de l'unitÃ© drop-in ou utiliser une commande telle que `systemctl edit jenkins --full` qui copie l'unitÃ© de service d'origine au lieu de crÃ©er une unitÃ© drop-in.

La modification de l'unitÃ© drop-in avec `systemctl edit jenkins` recharge automatiquement la configuration `systemd(1)`. Les paramÃ¨tres prendront effet au prochain redÃ©marrage de Jenkins. Si vous modifiez l'unitÃ© drop-in sans `systemctl(1)`, vous devez exÃ©cuter `systemctl daemon-reload` pour que les modifications prennent effet.

Un dernier point Ã  mentionner concernant l'unitÃ© de service est son utilisation de spÃ©cificateurs, qui peuvent Ãªtre peu familiers Ã  certains utilisateurs. L'unitÃ© drop-in n'effectue pas d'expansion de shell. Les spÃ©cificateurs peuvent insÃ©rer des informations contextuelles (telles que le nom d'hÃ´te du systÃ¨me, le nom de l'unitÃ© et la version du noyau du systÃ¨me d'exploitation) dans l'unitÃ© drop-in. La documentation `systemd(1)` contient un [tableau des spÃ©cificateurs disponibles dans les fichiers d'unitÃ©](https://www.freedesktop.org/software/systemd/man/systemd.unit.html#id-1.13.3).

## DÃ©marrage des services

Une fois le service Jenkins systemd dÃ©fini, il peut Ãªtre dÃ©marrÃ© avec :

``` bash title="BASH"
# systemctl start jenkins
```

Si Jenkins ne signale pas la fin du dÃ©marrage dans le dÃ©lai configurÃ©, le service sera considÃ©rÃ© comme ayant Ã©chouÃ© et sera Ã  nouveau arrÃªtÃ©. Ã€ mesure que chaque Ã©tape d'initialisation (c'est-Ã -dire Â« Initialisation dÃ©marrÃ©e Â», Â« Tous les plugins rÃ©pertoriÃ©s Â», Â« Tous les plugins prÃ©parÃ©s Â», Â« Tous les plugins dÃ©marrÃ©s Â», Â« Augmentation de toutes les extensions Â», Â« Chargement de la configuration systÃ¨me Â», Â« Adaptation de la configuration systÃ¨me Â», Â« Chargement de toutes les tÃ¢ches Â», Â« Mise Ã  jour de la configuration de toutes les tÃ¢ches Â» et Â« Initialisation terminÃ©e Â») est atteint, le dÃ©lai d'expiration est prolongÃ© de la valeur de la propriÃ©tÃ© systÃ¨me `jenkins.model.Jenkins.extendTimeoutSeconds` (par dÃ©faut, 15 secondes).  Le dÃ©lai d'expiration peut Ãªtre configurÃ© Ã  l'aide de la directive `TimeoutStartSec` dans l'unitÃ© de service.

## ArrÃªt des services

Le service Jenkins `systemd` peut Ãªtre arrÃªtÃ© Ã  l'aide de la commande suivante :

``` bash title="BASH"
# systemctl stop jenkins
```

## RedÃ©marrage des services

Le service Jenkins `systemd` peut Ãªtre redÃ©marrÃ© Ã  l'aide de la commande suivante :

``` bash title="BASH"
# systemctl restart jenkins
```

## Rechargement des dÃ©finitions de service

AprÃ¨s avoir modifiÃ© les fichiers de configuration, il peut Ãªtre nÃ©cessaire de recharger la dÃ©finition du service Ã  l'aide de la commande suivante :

``` bash title="BASH"
# systemctl daemon-reload
```

## Lecture des journaux de service

Les journaux du service Jenkins peuvent Ãªtre lus Ã  l'aide de la commande suivante :

``` bash title="BASH"
journalctl -u jenkins
```

## Nettoyage des journaux de service

Les fichiers journaux conservÃ©s par `systemd` sont gÃ©nÃ©ralement configurÃ©s pour Ãªtre automatiquement rotÃ©s. Si vous souhaitez rÃ©duire la taille des fichiers journaux, utilisez la commande suivante :

``` bash title="BASH"
journalctl --vacuum-size=500M
```

## Affichage de l'Ã©tat du service

L'Ã©tat du service Jenkins `systemd` peut Ãªtre affichÃ© Ã  l'aide de la commande `systemctl status jenkins`. Vous trouverez ci-dessous quelques exemples.

AprÃ¨s la mise Ã  niveau des plugins :

``` bash title="BASH"
systemctl status jenkins
â— jenkins.service - Serveur d'intÃ©gration continue Jenkins
     ChargÃ© : chargÃ© (/lib/systemd/system/jenkins.service ; activÃ© ; prÃ©rÃ©glage du fournisseur : activÃ©)
    Drop-In : /etc/systemd/system/jenkins.service.d
             â””â”€override.conf
     Actif : actif (en cours d'exÃ©cution) [â€¦]
   PID principal : [â€¦] (java)
     Statut : Â« RedÃ©marrage dans 10 secondes Â»
```

Lorsque Jenkins est arrÃªtÃ© :

``` bash title="BASH"
systemctl status jenkins
â— jenkins.service - Serveur d'intÃ©gration continue Jenkins
     ChargÃ© : chargÃ© (/lib/systemd/system/jenkins.service ; activÃ© ; prÃ©rÃ©glage du fournisseur : activÃ©)
    Drop-In : /etc/systemd/system/jenkins.service.d
             â””â”€override.conf
     Actif : dÃ©sactivation (stop-sigterm) depuis [â€¦]
   PID principal : [â€¦] (java)
     Statut : Â« ArrÃªt de Jenkins Â»
```

Au dÃ©marrage de Jenkins :

``` bash title="BASH"
systemctl status jenkins
â— jenkins.service - Serveur d'intÃ©gration continue Jenkins
     ChargÃ© : chargÃ© (/lib/systemd/system/jenkins.service ; activÃ© ; prÃ©rÃ©glage du fournisseur : activÃ©)
    Drop-In : /etc/systemd/system/jenkins.service.d
             â””â”€override.conf
     Actif : activation (dÃ©marrage) depuis [â€¦]
   PID principal : [â€¦] (java)
```

AprÃ¨s un dÃ©marrage rÃ©ussi :

``` bash title="BASH"
systemctl status jenkins
â— jenkins.service - Serveur d'intÃ©gration continue Jenkins
     ChargÃ© : chargÃ© (/lib/systemd/system/jenkins.service ; activÃ© ; prÃ©rÃ©glage du fournisseur : activÃ©)
    Drop-In : /etc/systemd/system/jenkins.service.d
             â””â”€override.conf
     Actif : actif (en cours d'exÃ©cution) depuis [â€¦]
   PID principal : [â€¦] (java
```

## Pour aller plus loin

Quelques lectures recommandÃ©es sur ce sujet :

* [Tutoriel sur les services et unitÃ©s systemd de DigitalOcean](https://www.digitalocean.com/community/tutorials/how-to-use-systemctl-to-manage-systemd-services-and-units) ;
* [Comprendre et administrer systemd](https://docs.fedoraproject.org/en-US/quick-docs/understanding-and-administering-systemd/) par le projet Fedora ;
* [Documentation de rÃ©fÃ©rence sur systemd](https://www.freedesktop.org/wiki/Software/systemd/) par freedesktop.org ;
* [Wiki Debian : systemd](https://wiki.debian.org/systemd).

